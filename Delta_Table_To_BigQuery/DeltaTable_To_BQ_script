DECLARE BUCKET STRING DEFAULT "ecommerce_de_project_97";
DECLARE FOLDER STRING DEFAULT "DeltaTables/products";
DECLARE DATASET STRING DEFAULT "delta_lake";
DECLARE DELTA_TABLE STRING DEFAULT "products";
#
# Implementation
#
DECLARE XXX_PARQUET STRING;
DECLARE XXX_DELTA_LOG STRING;
DECLARE GS_PARQUET STRING;
DECLARE GS_JSON STRING;
DECLARE DELTA_TABLE_VIEW STRING;
DECLARE PATH STRING;
SET PATH = FORMAT("gs://%s/%s/", BUCKET, FOLDER);
SET XXX_PARQUET = FORMAT("%s.%s_parquet", DATASET, DELTA_TABLE);
SET XXX_DELTA_LOG = FORMAT("%s.%s_delta_log", DATASET, DELTA_TABLE);
SET GS_PARQUET = FORMAT("gs://%s/%s/part*.parquet", BUCKET, FOLDER);
SET GS_JSON = FORMAT("gs://%s/%s/_delta_log/*.json", BUCKET, FOLDER);
SET DELTA_TABLE_VIEW = FORMAT("%s.%s_view", DATASET, DELTA_TABLE);
EXECUTE IMMEDIATE FORMAT("CREATE OR REPLACE EXTERNAL TABLE %s OPTIONS (format = 'PARQUET', uris = ['%s'])", XXX_PARQUET, GS_PARQUET);
EXECUTE IMMEDIATE FORMAT("CREATE OR REPLACE EXTERNAL TABLE %s OPTIONS (format = 'CSV', field_delimiter='|', uris = ['%s'])", XXX_DELTA_LOG, GS_JSON);
EXECUTE IMMEDIATE FORMAT("CREATE OR REPLACE VIEW `%s` AS SELECT * FROM  `%s` WHERE _FILE_NAME IN (SELECT CONCAT('%s' , JSON_EXTRACT_SCALAR(string_field_0, '$.add.path')) AS filepath FROM `%s` EXCEPT DISTINCT SELECT CONCAT('%s' , JSON_EXTRACT_SCALAR(string_field_0, '$.remove.path')) AS filepath FROM `%s`)", DELTA_TABLE_VIEW, XXX_PARQUET, PATH, XXX_DELTA_LOG, PATH, XXX_DELTA_LOG) ;